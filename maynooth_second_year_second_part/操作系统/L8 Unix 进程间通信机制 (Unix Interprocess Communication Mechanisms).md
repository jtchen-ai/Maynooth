# L8 Unix 进程间通信机制 (Unix Interprocess Communication Mechanisms)

* **管道 (Pipes)**
    * **匿名管道 (Unnamed Pipes)**
        * **定义**: 一种快速的、基于内核的流通信机制，用于在同一台机器上运行且有创建层级关系的进程之间通信。
        * **实现**: 由内核维护的、大小有限的内存缓冲区实现的先进先出 (FIFO) 字节流通信通道。
        * **特性**:
            * 一个进程向管道一端写入数据，通常由另一个进程从另一端读取。
            * 通常用作父子进程间的单向通信通道。
            * 父进程必须在创建子进程之前创建管道，以便子进程可以继承对它的访问权。
            * 管道的生命周期与有权访问它的进程的生命周期相同。
        * **在 C 程序中使用管道**:
            * **创建**: 使用 `pipe(fdptr)` 系统调用。
                * `fdptr` 是一个指向包含两个整数的数组的指针。
                * 调用后，数组将包含两个文件描述符，`fdptr[0]` 用于读，`fdptr[1]` 用于写。
            * **写入**: 使用 `write()` 系统调用将数据放入管道。
                * `write(fdptr[1], "some data", data_length);`
            * **读取**: 使用 `read()` 系统调用从管道获取数据。
                * `n = read(fdptr[0], buffer, buffer_size);`
                * 如果管道为空，`read` 函数会阻塞调用进程，直到可以从管道中读取数据。
                * 如果进程尝试读取的数据多于管道中已有的数据，`read` 会成功返回管道中所有的数据，并返回实际读取的字节数。

    * **命名管道 (Named Pipes / FIFO)**
        * **定义**: 可用于不相关进程之间通信的一种管道变体。
        * **实现**: 由内核实现为一种特殊的 FIFO 文件，因此独立进程可以通过文件系统的共享命名空间访问它。
        * **特性**: 命名管道可以在具有公共文件系统的机器之间共享。
        * **创建与使用**:
            * **创建**: 使用 `mknod()` 系统调用创建一个特殊文件。
                * `mknod("mypipe", 010777, 0);`
                * 文件类型由代码 `010` 指示为 fifo 特殊文件。
            * **打开**: 不相关的进程可以像打开常规文件一样打开命名管道进行读或写。
                * `namedpipe = open("mypipe", O_WRONLY);`
                * `namedpipe = open("mypipe", O_RDONLY);`
            * **语义 (Semantics)**:
                * 一个进程以读取模式打开管道时，如果没有进程以写入模式打开它，则该进程将被阻塞。
                * 同样，一个进程以写入模式打开管道时，如果没有进程以读取模式打开它，则该进程将被阻塞。

* **网络套接字 (Network Sockets)**
    * **定义**:
        * 是独立进程之间通信更常用和通用的方法，尤其是在无法共享内核数据结构或文件时（例如跨互联网通信）。
        * 一个通信通道可以看作是一对通信端点。
        * 套接字是由应用程序创建的、用于表示通信通道的数据结构。
    * **机制**:
        * 套接字必须被绑定或关联到通信系统内的某个实体（服务访问点/端口）。
        * 进程使用套接字接口的通信原语，将其地址空间的数据交换到负责处理交付的通信子系统的地址空间。
        * 通信服务（如 TCP/IP）负责在不同进程（通常在不同机器上）的套接字之间建立连接，并在网络中传输和路由消息。
        * 在互联网上，IP 地址和端口号被用作识别连接端点的方式。
    * **服务类型**:
        * **可靠性**: 创建时可以向传输控制协议 (TCP) 指定不同级别的消息交付可靠性。可以用更快的交付速度换取较低的可靠性（如数据报 DATAGRAM vs. 面向连接 CONNECTION ORIENTED）。
        * **连接**:
            * 一个套接字可以被底层通信协议“连接”到任何指定的远程套接字。
            * 连接后，发送到本地套接字的数据字节将被传送到远程套接字。
            * 远程进程“监听”其套接字并接收发送到字节流中的数据。
    * **基于套接字的客户端/服务器通信 (Socket-based Client/Server Communication)** 
        * **服务器端流程**:
            1. `socket()`: 创建套接字。
            2. `bind()`: 将套接字与一个知名的IP端口关联。
            3. `listen()`: 将套接字标记为被动套接字，用于接受传入的连接请求。
            4. `accept()`: 阻塞，直到有客户端的连接请求到达。
        * **客户端流程**:
            1. `socket()`: 创建套接字。
            2. `connect()`: 发起与服务器的连接（执行TCP三次握手）。
            3. `write()`: 发送数据（请求）。
            4. `read()`: 接收数据（回复）。
            5. `close()`: 关闭连接。