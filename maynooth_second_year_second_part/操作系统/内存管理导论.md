# 内存管理导论

## 1. 计算机体系结构基础（Computer Architecture Fundamentals）

### 冯・诺依曼体系结构（Von Neumann Architecture）

- **定义**：1945 年由约翰・冯・诺依曼等人描述的一种存储程序计算机模型，至今仍是现代计算机操作的基础。

- 核心组件

  ：

  - 一个用于存放指令和指令所需数据的内存。
  - 一个用于从内存中提取指令的控制单元。
  - 一个用于执行指定操作的算术处理器。
  - 一条用于在内存和 CPU 之间传输数据的总线。
  - 用于与系统内外传输数据的输入 / 输出机制和外围设备。

- 特点与瓶颈

  ：

  - 内存和 CPU 之间只有**单一总线**，因此取指令和数据操作不能同时进行。
  - 指令和数据存储在同一内存中。

### 哈佛体系结构（Harvard Architecture）

- **特点**：提出了一个具有**独立指令和数据路径**以及**独立内存系统**的系统。
- **优势**：允许取指令与数据加载 / 存储并行且独立地进行。

### 改进的哈佛体系结构（Modified Harvard Architecture）

- **应用**：通用计算机所采用的架构。
- **特点**：数据和代码可以共同存储在统一的主存中，但使用**独立的 CPU 缓存**来分别存放指令和数据，以获得更好的性能。

## 2. 内存层次结构（Memory Hierarchy）

### 概念

- 系统内存由一个层次结构组成，其中每个层次使用具有不同特性的存储技术和接口。
- 内存系统是不同存储技术的配置，旨在满足特定的成本 / 容量 / 性能目标。

### 层次划分

- **处理器寄存器（CPU Registers）**：速度超快，超级昂贵，容量极小。
- **CPU 缓存（Cache Memory）**：速度快，昂贵，容量小。
- **主物理内存（Main Electrical Memory / RAM）**：速度快，价格合理，容量中等。
- **固态内存 / 虚拟内存（Solid State / Virtual Memory）**：速度中等，价格合理，容量中等。
- **磁性和光学存储介质（Secondary Storage）**：速度慢，便宜，容量大。

### 性能考量

- CPU 可直接访问的内存（寄存器、缓存、主存）的访问时间以纳秒（10−9秒）计。
- 机械设备上的数据（如硬盘）访问时间以毫秒（10−3秒）计，必须先由文件系统调入主存，处理器才能访问。
- 如果内存系统不能以与处理器相当的速度提供指令，处理器的性能将无法得到充分发挥。

## 3. 内存管理器的角色（Role of the Memory Manager）

### 职责范围

- 操作系统内存管理器主要负责**主内存**和**二级存储交换空间**的分配和管理。
- 主存到 CPU 缓存的映射是由**硬件**完成的，不受软件控制，以保证足够高的性能。

### 核心功能

- 跟踪内存的哪些部分正在使用，哪些是空闲的。
- 在进程需要时为其分配内存，在进程结束后回收内存。
- 在虚拟内存系统中，当主存不足以容纳所有进程时，管理主存和磁盘之间的交换。

## 4. 内存管理方案（Memory Management Schemes）

### 单道程序设计（Monoprogramming）

- **概念**：一次只运行一个程序，与操作系统共享内存。
- **缺点**：设备利用率极低，因为计算机资源大部分时间在等待单个用户的活动。
- **应用**：用于非常早期的计算机或嵌入式系统。

### 多道程序设计（Multiprogramming）

#### 引入的问题

- **保护（Protection）**：需要保护一个进程的内存空间不受其他进程的干扰。
- **重定位（Relocation）**：程序在编写和编译时不知道未来会被加载到内存的哪个位置，因此程序中的相对地址需要在运行时映射到正确的物理地址。

#### 硬件支持：基址和界限寄存器（Base and Limit Registers）

- **地址转换**：硬件通过将进程生成的逻辑地址（相对于地址 0）与**基址寄存器**的值相加，来转换为物理地址。

- 保护机制

  ：

  - **基址寄存器**防止进程访问其分区以下的内存。
  - **界限寄存器**存储了分区的大小。如果进程生成的地址大于界限寄存器的值，处理器会判定为地址空间异常，并终止该进程。

### 内存分区方案（Memory Partitioning Schemes）

#### 固定分区（Fixed Partitions）

- 问题

  ：

  - **内部碎片（Internal Fragmentation）**：当一个小进程被分配到一个大分区时，分区内未被使用的空间被浪费。
  - **外部碎片（External Fragmentation）**：系统中存在足够的总空闲内存，但由于这些空闲空间不连续，导致无法装入一个需要更大连续空间的进程。

#### 动态分区（Dynamic Partitions）

- **概念**：根据每个进程的请求，从可用空闲内存中动态地创建一个精确大小的分区。
- **问题**：随着时间的推移，内存中的空闲区域会变得越来越碎片化，同样导致**外部碎片**。
- 解决方案：内存紧缩（Compaction）
  - **定义**：通过重定位活动进程的地址空间，将所有分散的空闲区域合并成一个大的连续空闲区。
  - **缺点**：这是一项耗时的操作，因为处理器需要物理移动大量内存数据