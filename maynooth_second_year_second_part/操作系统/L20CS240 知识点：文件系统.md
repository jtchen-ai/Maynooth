# CS240 知识点：文件系统

## 1. 文件系统基础 (File System Fundamentals)

### 定义 (Definitions)

- **文件 (File)**：由创建者定义并存储在非易失性存储上的一组相关信息。
- **文件系统 (File System)**：将文件映射到存储设备，并为用户提供访问和操作接口的软件。

### 存储设备 (Storage Devices)

#### 磁盘类型 (Disk Types)

- **固态硬盘 (SSD)**：性能高、功耗低、环境适应性强、无噪音，多用于移动设备。
- **机械硬盘 (Magnetic Drives)**：桌面系统主导，大容量场景成本低，文件系统设计常针对此类硬盘优化。

#### 机械硬盘结构 (Magnetic Disk Structure)

- 磁性表面组织为固定大小的数据块，地址由盘面号、磁道号和块号组成。
- 磁盘容量 = 块数量 × 块大小。

## 2. 文件系统设计 (File System Design)

### 设计要求 (Design Requirements)

- 优化块分配与释放，确保性能、数据持久性和完整性。
- 实现文件到设备的映射、目录组织、文件保护与共享，支持多存储设备。

### 用户接口 (User Interface)

- 核心功能

  ：

  - **Open**：准备文件供操作系统引用。
  - **Close**：阻止文件进一步引用。
  - **Create**：创建新文件。
  - **Delete**：移除文件。
  - **Copy**：创建文件新版本。
  - **Rename**：修改文件名。
  - **Get/Set Attributes**：获取或修改文件属性（权限、大小、修改时间等）。

## 3. 文件组织与访问 (File Organization & Access)

### 文件组织 (File Organisation)

- 无结构：字节集合（如文本文件）。
- 结构化：记录集合（固定或可变大小），首字段常为唯一键。
- 文件系统可提供记录级操作接口（索引、搜索、更新等）。

### 文件访问操作 (File Access Operations)

- **Read**：从文件复制字节到进程。
- **Write**：从进程输出字节到文件。
- **Seek**：定位到文件指定位置。
- **Append**：定位到文件末尾并添加数据。

### 文件访问流程示例 (File Access Walkthrough)

- **请求示例**：`Read(FileA, Record=6, Destination=Buffer, NumBytes=250)`

- 步骤

  ：

  1. 通过目录文件获取文件信息（名称、位置等）。
  2. 连续分配时，目录条目含起始位置和大小。
  3. 计算第 6 条记录的字节偏移量：`(6-1)×250=1250`。
  4. 计算逻辑块号：`1250/1000=1`（第二个逻辑块）。
  5. 映射物理块：`逻辑块号 + 起始块号 = 1+2=3`，读取物理块 3。
  6. 提取记录 6 并复制到缓冲区。

### 提高效率 (Improving Efficiency)

- **问题**：顺序读取 11 条记录需 22 次磁盘操作（11 次目录查询 + 11 次数据块读取）。

- 解决方案

  ：

  1. **打开 / 关闭文件**：打开时缓存目录信息，关闭时更新目录，将目录操作从 11 次减至 1 次。
  2. **磁盘块缓存**：缓存最近使用的块，减少数据块读取次数（如从 11 次减至 3 次），总操作减至 4 次。

## 4. 空间分配方法 (Space Allocation Methods)

### 跟踪可用空间

文件系统需跟踪空闲区域，以便自动分配空间。

### 连续分配 (Contiguous Allocation)

- **优点**：目录条目简单，位置计算高效。
- **缺点**：文件大小动态变化时需重定位，效率低。

### 链接分配 (Linked Allocation)

- **工作方式**：目录含文件首块指针，每个块含后继块指针。
- **优点**：顺序访问性能好。
- **缺点**：随机访问需遍历链表，指针占用空间，指针链易损坏。
- **FAT (文件分配表)**：集中存储链接指针，提升随机访问性能。

### 索引分配 (Indexed Allocation)

- **工作方式**：为文件分配索引块，映射逻辑块到物理块，目录指向索引块。
- **优点**：支持逻辑块分散存储，顺序和随机访问性能好。
- **缺点**：索引块占用空间，小文件易浪费空间，索引块损坏会丢失数据。

### 最佳方法选择

- 组合多种分配技术：固定大小文件用连续分配，大型数据库文件用索引分配。

## 5. 分层文件系统 (Hierarchical File System)

### 命名空间 (Name Space)

- **问题**：平面命名空间中文件过多时，命名和查找困难。
- **解决方案**：将文件按应用或相关性分组到独立目录中，目录是特殊文件，包含命名空间子集信息。

### 路径与导航 (Paths & Navigation)

- **完整路径名**：通过路径定位文件，同一目录内文件名唯一。

- **根目录**：命名空间顶层目录（Unix 用`/`，Windows 用`\`）。

- **当前目录**：用户提供的非根路径名相对于当前目录。

- 父目录与当前目录指针

  ：

  - Unix/Windows 目录含指向父目录（`..`）和自身（`.`）的指针，便于导航。

## 6. Unix 文件系统实现 (Unix File System Implementation)

### 整体结构 (Overall Structure)

- **引导块**：包含引导 Unix 内核的代码。
- **超级块**：存储 inode 和空闲数据块列表信息。
- **inode 列表**：决定文件系统最大文件数。
- **数据块**：存储文件数据、目录和索引块信息。

### Inode（索引节点）

- **定义**：描述文件元信息（所有者、权限等）和数据块位置的数据结构。

- 结构

  ：

  - 前 12 个条目直接指向数据块。
  - 大文件通过间接块（单间接、双间接、三间接）扩展，支持高效随机寻道。

### 目录文件 (Directory Files)

- 维护文件名与 inode 的映射，含指向自身（`.`）和父目录（`..`）的 inode 指针，便于遍历。

### 统一文件命名空间 (Unified File Namespace)

- Unix 将不同设备的文件系统挂载到根文件系统的目录挂载点，内核通过挂载表透明遍历。

### 内核数据结构 (Kernel Data Structures)

- **用户描述符表**：每个进程的打开文件指针数组。
- **系统文件表**：集中存储系统中正在使用的文件结构。
- **vnode 结构**：动态分配，引用文件并包含数据块指针，同一文件仅一个 vnode 实例。



