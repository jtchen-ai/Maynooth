# 内存



## 1. 内存概述 (Memory Overview)

- 内存架构 (Memory Architecture)

  - 定义：用于实现电子计算机数据存储的方法，旨在以最快、最可靠、最耐用和最便宜的方式组合来存储和检索信息。

- 内存的历史演变 (Historical Evolution of Memory)

  - 楔形文字 (Cuneiform Script)：公元前 3100 年，土耳其，苏美尔人。
  - 石碑 (Stone Tablet)：公元前 5000 年，容量百字节级别。
  - 纸莎草纸 (Papyrus)：公元前 3000 年，容量 1K 字节。
  - 羊皮纸 (Vellum)：公元 800 年，容量数十 K 字节。
  - 纸质书 (Paper book)：公元 1455 年。
  - 磁带 (Tape)：容量 660KB (C90)。
  - VHS：1976 年，容量 6GB（200 分钟）。

- 现代内存基础 (Foundation of Modern Memory)

  - CMOS (互补金属氧化物半导体)

    ：

    - 由一个 p 沟道和一个 n 沟道晶体管组成。
    - 只有在开关切换时才会产生功耗。

## 2. 内存层次结构 (Memory Hierarchy)

- 结构层次 (Pyramid Structure)
  - **寄存器 (Registers)**：位于 CPU 芯片上，容量为字节级，访问速度最快（<3 个时钟周期）。
  - **缓存 (Cache)**：位于 CPU 芯片上或外部，容量为 MB 级，速度约 10ns。
  - **主内存 (Main Memory)**：位于主板上，容量为 GB 级，速度约 80ns。
  - **磁盘缓存 (Disk Cache)**。
  - **磁盘 (Magnetic Disk)**：位于 PC 机箱内，容量为 TB 级，延迟约 10ms，非易失性。
  - **光盘 / DVD (Optical Disk)**：可在 PC 内外使用，容量为 GB 级，延迟约 100ms，非易失性。
  - **磁带 (Magnetic Tape)**。
- 特性 (Characteristics)
  - 位置 (Location)、容量 (Capacity)、访问方法 (Access Method)、速度 (Speed)、易失性 (Volatility)。

## 3. 随机存取存储器 (RAM)

- 静态 RAM (Static Ram - SRAM)

  - **构造**：基于触发器 (Flip Flops)。

  - 特点

    ：

    - 每个存储单元占用大量空间。
    - 速度非常快，约 10ns。
    - 无需刷新。
    - 易失性。
    - 用于缓存。

  - **电路**：每个位需要多达 8 个 FET（场效应晶体管）。

- 动态 RAM (Dynamic Ram - DRAM)

  - **构造**：基于存储在 FET 门电路上的电荷。

  - 特点

    ：

    - 存储密度更高，成本更低。
    - 速度较慢，约 60ns-100ns。
    - 需要额外的刷新控制信号。
    - 易失性。
    - 在相同硅片面积下，DRAM 提供的内存容量约是 SRAM 的 3 倍。

  - **电路**：每个位大约需要 1 个 FET。

  - DRAM 周期

    ：

    - 必须在 2ms 内重写（刷新）每个存储单元，以防电荷丢失。
    - 控制信号：RAS (行地址选择) 和 CAS (列地址选择)。
    - 访问 DRAM 时，微处理器必须将地址分成两半。
    - 由于速度较慢，微处理器访问 DRAM 时需要引入等待状态。

## 4. 缓存 (Cache)

- 基本原理 (Principle)

  - **工作方式**：将当前正在使用的数据和代码从 DRAM 复制到 SRAM（缓存）中。
  - **控制器**：缓存控制器检查所请求的数据是在缓存中还是在主存中。
  - **命中 (Hit)**：如果数据在缓存中，则直接快速发送给微处理器。
  - **未命中 (Miss)**：如果数据不在缓存中，则从主存中读取，发送给微处理器的同时在缓存中保留一个副本。
  - **命中率 (Hit Rate)**：S-RAM 读取次数占总读取次数的百分比，是衡量缓存有效性的指标，在 PC 上通常为 90%。

- 局部性原理 (Locality of Reference)

  - **时间局部性 (Temporal locality)**：如果一个项目被引用，它很可能在不久后再次被引用。
  - **空间局部性 (Spatial locality)**：如果一个项目被引用，它附近的项目很可能在不久后被引用。

- 缓存组织 (Organization)

  - 直接映射缓存 (Direct Mapped Cache)

    ：

    - 主存中的特定行总是映射到缓存中的同一行。
    - 缓存目录存储每行在主存中的页位置（称为标签 Tag）。
    - **抖动 (Thrashing)**：如果处理器在不同页面之间快速切换，且这些页面映射到缓存的同一位置，会导致系统变慢。

  - 二路组相联缓存 (Two-Way Set Associative)

    ：

    - 将缓存分成两个独立的缓存区，以减少抖动。
    - 使用一个额外的 LRU（最近最少使用）位来标识哪个缓存包含最新的版本。

  - 全相联缓存 (Fully Associative)

    ：

    - 主存中的一行可以写入缓存的任何位置。
    - 缓存目录中的每个标签需要 30 位。
    - 问题：需要搜索整个目录来查找数据；缓存满时如何丢弃旧数据。

- 性能分析 (Performance Analysis)

  - 阿姆达尔定律 (Amdahl's Law)

    ：使用某种更快执行模式所能获得的改进，受限于该更快模式可被使用的时间比例。

    - Speedup = 1 / ((1 - p) + (p / s))。
    - p 是受益于改进资源的部分所占的原始执行时间比例，s 是改进带来的速度提升。
    - 示例：对于命中率为 95% (p=0.95)，缓存速度比 DRAM 快 10 倍 (s=10) 的系统，整体内存速度提升约 6.89 倍。

- 写策略 (Write Policies)

  - **写通 (Write through)**：每次写入缓存时，也同时写入主存。读取速度快，但写入速度受限于 DRAM。
  - **写回 (Write back)**：数据只写入缓存。当该缓存块被替换时，旧块才被传送回主存。

- 多级缓存 (Multilevel caches)

  - 现代 PC 有两级或更多级的缓存。
  - **一级缓存 (L1)**：内置于微处理器芯片上，容量通常为 1K 到 32K，可以实现零等待状态。
  - **二级缓存 (L2)**：示例为 2MB，500MHz。

## 5. 直接内存访问 (Direct Memory Access - DMA)

- **概念**：允许设备直接写入内存，从而解放 CPU 时间的技术。
- **应用**：用于如帧捕获器、声卡等设备。
- 工作流程 (Sequence of events)
  1. 设备准备好后，将 DREQ（DMA 请求）设为高电平。
  2. DMA 控制器向微处理器发送 HOLD（保持请求）。
  3. 微处理器准备好后，将 HLDA（保持确认）设为高电平。
  4. DMA 控制器将数据和地址线切换给设备。
  5. DMA 发送 DACK（DMA 确认）信号，设备开始向内存写入数据。
  6. 完成后，HOLD 被释放，微处理器重新获得对内存的访问权。

## 6. 只读存储器 (Read-Only Memory - ROM)

- **特性**：非易失性存储器，通常包含 BIOS 和引导序列代码。
- 类型 (Types)
  - **掩膜编程 ROM (Mask Programmed ROM)**：在制造过程中编程，无法更改。
  - **PROM**：一次性可编程 ROM，通过烧断设备中的熔丝链接进行编程。
  - **EPROM**：可通过电学方式编程（将电荷留在 FET 的门上），使用紫外线擦除。
  - **EEPROM**：可通过电学方式编程和重新编程。
- **使用**：ROM 速度较慢，有时其内容在开机后会被复制到 SRAM 中。

## 7. 虚拟内存 (Virtual Memory)

- 概念

  ：

  - CPU 映射的地址空间称为虚拟内存（如 64GB）。
  - 物理上可用的内存是主内存（如 4GB）。
  - 虚拟内存系统使用外部存储（如硬盘）来存储数据。
  - 外部存储的页面被换入主内存中使用，方法与缓存类似。

- 性能

  ：

  - 当主内存不足时，操作系统开始使用虚拟内存，这会导致系统速度显著下降。
  - 使用虚拟内存的未命中惩罚可能高达 100,000 个时钟周期。